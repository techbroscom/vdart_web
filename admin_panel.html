<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* Styling for transaction history */
.transaction-history {
    margin-top: 20px;
}

.transaction-history h2 {
    margin-bottom: 10px;
}

.store-transaction-list {
    list-style-type: none;
    padding-left: 0;
}

.store-transaction-list li {
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
}

.store-name {
    font-weight: bold;
    margin-bottom: 5px;
}

.transaction-details {
    margin-left: 20px;
}

.transaction-details p {
    margin: 5px 0;
}

.sidebar {
    height: 100vh;
    width: 250px;
    position: fixed;
    top: 0;
    left: 0; /* Updated */
    background-color: #333;
    padding-top: 20px;
    z-index: 1;
    transition: left 0.3s;
    overflow-y: auto; /* Added */
}

.sidebar a {
    padding: 10px 15px;
    text-decoration: none;
    font-size: 18px;
    color: white;
    display: block;
}

.sidebar a.active {
    background-color: #555;
}

.sidebar a:hover {
    background-color: #555;
}

.content {
    margin-left: 250px;
    padding: 20px;
}

.menu-icon {
    display: none; /* Hide the menu icon in desktop view */
}

@media screen and (max-width: 768px) {
    .sidebar {
        left: -250px;
    }

    .sidebar.show {
        left: 0;
    }

    .menu-icon {
        display: block;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 2;
        font-size: 20px;
        background-color: #333;
        color: white;
        border: none;
        cursor: pointer;
    }

    .content {
        margin-left: 0;
    }

    /* style for config */

/* Add these styles to your existing CSS */
#locationsList {
    list-style-type: none;
    padding: 0;
}

#locationsList li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 5px;
}

#locationsList li input {
    flex: 1;
    margin-right: 5px;
}

#locationsList li button {
    margin-left: 5px;
}

}
    </style>
</head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

<script>
            var adminData = [];
            var empData = [];
            var feedbacksData = [];
            var creditHistoryData = [];
            var encashData = [];
            var logDataList = [];
</script>
<body>
    <button class="menu-icon" onclick="toggleSidebar()">☰</button>

    <div class="sidebar">
        <a href="#" class="active" onclick="showContent('search')">Search</a>
        <a href="#" onclick="showContent('employee')">Employee Data</a>
        <a href="#" onclick="showContent('store')">Store Data</a>
        <a href="#" onclick="showContent('admin')">Admin Data</a>
        <a href="#" onclick="showContent('storeMenu')">Store Menu</a>
        <a href="#" onclick="showContent('credit')">Credit Coins</a>
        <a href="#" onclick="showContent('createUser')">Add New User</a>
        <a href="#" onclick="showContent('tranHis')">Transaction History</a>
        <a href="#" onclick="showContent('credHis')">Credit History</a>
        <a href="#" onclick="showContent('encashData')">Encash</a>
        <a href="#" onclick="showContent('encashHis')">Encash History</a>
        <a href="#" onclick="showContent('feedback')">Feedback</a>
        <a href="#" onclick="showContent('config')">Configuration</a>
        <a href="#" onclick="showContent('logs')">Logs</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
    <div class="content" id="content">
        <div id="search">
            <h2>Search</h2>
            <form id="searchForm">
                <input type="text" id="searchInput" placeholder="Enter user ID">
                <button type="submit"><i class="fas fa-search"></i> Search</button>
            </form>
            <div id="searchResult" style="display:none;">
                <h3>User Details</h3>
                <p id="userDetails"></p>
                <button onclick="updateUserDetails()">Update Details</button>
                <button onclick="updateUserPassword()">Reset Password</button>
                <!-- <button onclick="updateUserBalance()">Update Balance</button> -->
            </div>
        </div>

        <div id="employee" style="display:none;">
            <h2>Employee Data <button onclick="downloadDataExcel(empData, 'Employee_data')" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h2>
            <div class="table-responsive">
                <table id="employeeTable" class="table"></table>
            </div>
        </div>

        <div id="store" style="display:none;">
            <h2>Store Data</h2>
            <p>This is the Settings content.</p>
        </div>

        <div id="storeMenu" style="display:none;">
            <h2>Store Menu Data</h2>
            
            <div>
                <select id="storeSelect">
                    <option>Select a store</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div id="menuList"></div>
            <div id="addItemForm">
                <input type="text" id="itemName" placeholder="Item Name">
                <input type="number" id="itemPrice" placeholder="Item Price">
                <button id="addItemButton">Add Item</button>
            </div>

        </div>

        <div id="encashData" style="display:none;">
            <h2>Encash</h2>
            <form id="encashForm">
                <div class="mb-3">
                    <label for="selectStore" class="form-label">Select Store:</label>
                    <select id="selectStore" name="selectStore" class="form-select form-select-lg mb-3">
                    </select>
                </div>
                <div class="mb-3">
                    <label for="storeName" class="form-label">Store Name:</label>
                    <input type="text" id="storeName" name="storeName" required class="form-control">
                </div>
        
                <div class="mb-3">
                    <label for="encashAmount" class="form-label">Encashed Amount:</label>
                    <input type="number" id="encashAmount" name="encashAmount" required class="form-control">
                </div>
        
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
        

        <div id="credHis" class="credit-transaction-history" style="display:none;">
            <h2>Credit History <button onclick="downloadDataExcel(creditHistoryData, 'Credit')" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h2>
            <ul id="creditHisList" class="list-group"></ul>
        </div>

        <div id="feedback" style="display:none;">
            <h2>Feedback <button onclick="downloadDataExcel(feedbacksData, 'Feedbacks')" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h2>
            <ul id="feedbackList" class="list-group"></ul>
        </div>

        <div id="admin" style="display:none;">
            <h2>Admin Data <button onclick="downloadDataExcel(adminData, 'Admin_data')" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h2>
            <div class="table-responsive">
                <table id="adminTable" class="table"></table>
            </div>
        </div>
        
        <div id="tranHis" class="transaction-history" style="display: none;">
        <div class="row">
            <div class="col">
                <h3>Transaction History <button id="downloadButtonTransactions" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h3>
                <ul id="transactionHistoryList" class="list-group">
                    <!-- Transaction history items will be dynamically added here -->
                </ul>
            </div>
        </div>
        </div>

        <div id="credit" style="display:none;">
            <h2>Credit Coins</h2>
            <form id="creditForm">
                <div class="form-group">
                    <label for="locationSelect">Location:</label>
                    <select class="form-control" id="creditLocationSelect" name="location">
                        <option value="">Select Location</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="coinsInput">Coins:</label>
                    <input type="number" class="form-control" id="coinsInput" required>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="addWithExistingBalance">
                    <label class="form-check-label" for="addWithExistingBalance">Add with existing balance</label>
                </div>
                <button type="submit" class="btn btn-primary">Credit Coins</button>
            </form>
        </div>

        <div id="config" style="display:none;">
            <h2>Configuration</h2>
            <div class="mb-3">
                <label for="coinsLimit">Coins Limit:</label>
                <input type="text" id="coinsLimit">
                <button onclick="updateCoinsLimit()" class="btn btn-primary">Update Coins Limit</button>
            </div>
            <div class="mb-3">
                <h3>Locations</h3>
                <ul id="locationsList"></ul>
                <button onclick="addLocation()" class="btn btn-primary">Add Location</button>
            </div>
            <div class="mb-3">
                <h3>User Types</h3>
                <ul id="userTypesList"></ul>
                <button onclick="addUserType()" class="btn btn-primary">Add User Type</button>
            </div>
        </div>
        
        <div id="createUser" style="display:none;">
            <h2>Create New User</h2>
            <form id="createUserForm" class="needs-validation" novalidate onsubmit="handleSubmitCreateUsers(event)">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="newUserId" class="form-label">User ID:</label>
                            <input type="text" class="form-control" id="newUserId" name="newUserId" oninput="updatePassword()" required>
                            <div class="invalid-feedback">
                                Please enter a User ID.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="newUserName" class="form-label">User Name:</label>
                            <input type="text" class="form-control" id="newUserName" name="newUserName" required>
                            <div class="invalid-feedback">
                                Please enter a User Name.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password:</label>
                            <input type="text" class="form-control" id="newUserPassword" name="newUserPassword" required readonly>
                            <div class="invalid-feedback">
                                Please enter a Password.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="newUserLocation" class="form-label">Location:</label>
                            <select class="form-control" id="newUserLocation" name="newUserLocation" required>
                            </select>
                            <div class="invalid-feedback">
                                Please select a Location.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="newUserType" class="form-label">User Type:</label>
                            <select class="form-control" id="newUserType" name="newUserType" required>
                                <option value="Employee">Employee</option>
                                <option value="Store">Store</option>
                                <option value="Intern">Intern</option>
                                <option value="Admin">Admin</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a User Type.
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="addUserToList()">Add User</button>
                <button type="submit" class="btn btn-success">Create Users</button>
            </form>
            
            <table id="userList" class="table">
                <thead>
                    <tr>
                        <th scope="col">User ID</th>
                        <th scope="col">User Name</th>
                        <th scope="col">Location</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- User list rows will be added here dynamically -->
                </tbody>
            </table>
        </div>
        
        <div id="encashHis" class="credit-transaction-history" style="display:none;">
            <h2>Encash History <button onclick="downloadDataExcel(encashData, 'Encash_data')" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h2>
            <ul id="encashHisList" class="list-group"></ul>
        </div>

        <div id="logs" style="display:none;">
            <h2>Logs <button onclick="downloadDataExcel(logDataList, 'Logs')" style="background: none; border: none; padding: 0;"><img src="assets/icons/excel.png" alt="Excel Icon"></button></h2>
            <ul id="logsList" class="list-group"></ul>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="config.js"></script>

    <script>
        function showContent(id) {
            var contentDivs = document.getElementsByClassName('content')[0].children;
            var sidebarLinks = document.getElementsByClassName('sidebar')[0].children;
            for (var i = 0; i < contentDivs.length; i++) {
                contentDivs[i].style.display = 'none';
                sidebarLinks[i].classList.remove('active');
            }
            document.getElementById(id).style.display = 'block';
            event.currentTarget.classList.add('active');

            if (id === 'employee') {
                showEmployeeData();
            } else if (id === 'store') {
                showStoreData();
            } else if (id === 'admin') {
                showAdminData();
            } else if (id === 'credit') {
                populateLocationDropdown(); // Populate location dropdown when Credit Coins section is shown
            } else if (id === 'tranHis') {
                showTransactionHistory(); // Populate location dropdown when Credit Coins section is shown
            } else if (id === 'feedback') {
                showFeedbacks(); // Populate location dropdown when Credit Coins section is shown
            } else if (id === 'credHis') {
                showCreditTransactionHistory(); // Populate location dropdown when Credit Coins section is shown
            } else if (id === 'encashData') {
                showEncashData();
            } else if (id === 'encashHis') {
                showEncashHistory();
            } else if (id === 'logs') {
                showLogsHistory();
            } else if (id === 'storeMenu') {
                renderStores();
            }

            // Close the sidebar on mobile view
    if (window.innerWidth <= 768) {
        closeSidebar();
    }
        }

        const userDetails = JSON.parse(localStorage.getItem('userDetails'));
        if (!userDetails || userDetails.userType!='Admin') {
            console.log('User details not found');
            window.location.href = 'index.html';
        }

        // Show the first content by default
        document.getElementById('search').style.display = 'block';
        // Firebase configuration
// const firebaseConfig = {
//   apiKey: "AIzaSyCvcxuv1-MWBtHMIUkeqGH_gfyBWaNN7K0",
//   authDomain: "vdarttest.firebaseapp.com",
//   projectId: "vdarttest",
//   storageBucket: "vdarttest.appspot.com",
//   messagingSenderId: "157342186908",
//   databaseURL: "https://vdarttest-default-rtdb.asia-southeast1.firebasedatabase.app",
//   appId: "1:157342186908:web:ea6c53598d3e9d1cab9c59",
//   measurementId: "G-NVXLVD13D1"
// };
// firebase.initializeApp(firebaseConfig);
var database = firebase.database();        

// Reference to your Firebase Realtime Database
const logsRef = database.ref('logs');

// Function to add a log entry to the database
function addLog(message) {
    logsRef.push({
        userId: userDetails.id,
        userName: userDetails.userName,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        message: message
    });
}

function searchUser(event) {
    event.preventDefault();
    var userId = document.getElementById('searchInput').value;
    var userDetailsRef = database.ref('userDetails/' + userId);
    userDetailsRef.once('value', function(snapshot) {
        var userDetails = snapshot.val();
        if (userDetails) {
            var message = userDetails.message ? userDetails.message : "No message";
            var orderStore = userDetails.orderStore ? userDetails.orderStore : "No order store";
            var pendingTransId = userDetails.pendingTransId ? userDetails.pendingTransId : "No pending transaction ID";

            var userDetailsHtml = `
                <p><strong>User ID:</strong> ${userDetails.id}</p>
                <p><strong>User Name:</strong> <input type="text" id="userNameInput" value="${userDetails.userName}"></p>
                <p><strong>User Type:</strong> ${userDetails.userType}</p>
                <p><strong>Balance:</strong> <input type="text" id="balance" value="${userDetails.balance}"></p>
                <p><strong>Coins Utilized:</strong> <input type="text" id="coinsUtilInput" value="${userDetails.coinsUtil}"></p>
                <p><strong>Location:</strong> <input type="text" id="userLoc" value="${userDetails.location}"></p>
                <p><strong>Status:</strong>
                    <select id="statusInput">
                    <option value="Active" ${userDetails.status === 'Active' ? 'selected' : ''}>Active</option>
                    <option value="Inactive" ${userDetails.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                    </select>
                </p>
                <p><strong>Last Transaction Date:</strong> ${userDetails.lastTranDate}</p>
                <p><strong>Order Store:</strong> ${orderStore}</p>
                <p><strong>Message:</strong> ${message}</p>
                <p><strong>Pending Transaction ID:</strong> ${pendingTransId}</p>
            `;
            document.getElementById('userDetails').innerHTML = userDetailsHtml;
            document.getElementById('searchResult').style.display = 'block';
        } else {
            alert('User not found');
        }
    });
}


function updateUserDetails() {
    var userId = document.getElementById('searchInput').value;
    var userName = document.getElementById('userNameInput').value;
    var loc = document.getElementById('userLoc').value;
    var newBalance = parseInt(document.getElementById('balance').value);
    var coinsLimit = parseInt(document.getElementById('coinsUtilInput').value);
    var status = document.getElementById('statusInput').value;

    var newDetails = {
        userName: userName,
        coinsUtil: coinsLimit,
        balance: newBalance,
        location: loc,
        status: status
        // Add other fields to update if needed
    };
    var userDetailsRef = database.ref('userDetails/' + userId);
    userDetailsRef.update(newDetails, function(error) {
        if (error) {
            alert('Failed to update user details');
        } else {
            addLog('Changed details for user ' + userId);
            alert('User details updated successfully');
        }
    });
}

function updateUserPassword() {
    var userId = document.getElementById('searchInput').value;
    var passwrd = userId;

    // Confirm password reset
    var confirmReset = confirm('Are you sure you want to reset the password?');
    if (!confirmReset) {
        return; // Exit function if user cancels
    }

    var newDetails1 = {
        password: passwrd
        // Add other fields to update if needed
    };
    var userDetailsRef = database.ref('userDetails/' + userId);
    userDetailsRef.update(newDetails1, function(error) {
        if (error) {
            alert('Failed to update password');
        } else {
            addLog('Password reset for user ' + userId);
            alert('User password updated successfully');
        }
    });
}

// function updateUserBalance() {
//     var userId = document.getElementById('searchInput').value;

    

//     var newDetails1 = {
//         balance: passwrd
//         // Add other fields to update if needed
//     };
//     var userDetailsRef = database.ref('userDetails/' + userId);
//     userDetailsRef.update(newDetails1, function(error) {
//         if (error) {
//             alert('Failed to update balance');
//         } else {
//             addLog('Balance reset for user ' + userId);
//             alert('User password updated successfully');
//         }
//     });
// }

function showEmployeeData() {
    var userDetailsRef = database.ref('userDetails');
    userDetailsRef.once('value', function(snapshot) {
        var userDetails = snapshot.val();

        var employeeTableHtml = '<thead><tr><th>User ID</th><th>User Name</th><th>Balance</th><th>Location</th><th>Status</th></tr></thead>';
        employeeTableHtml += '<tbody>';

        for (var userId in userDetails) {
            if (userDetails[userId].userType === 'Employee') {
                employeeTableHtml += '<tr>';
                employeeTableHtml += '<td>' + userDetails[userId].id + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].userName + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].balance + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].location + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].status + '</td>';
                employeeTableHtml += '</tr>';

                empData.push({
                    'User ID': userDetails[userId].id,
                    'User Name': userDetails[userId].userName,
                    'Balance': userDetails[userId].balance,
                    'Location': userDetails[userId].location,
                    'Status': userDetails[userId].status
                });
            }
        }

        employeeTableHtml += '</tbody></table></div>';
        document.getElementById('employeeTable').innerHTML = employeeTableHtml;

    });
}

function showStoreData() {
    var userDetailsRef = database.ref('userDetails');
    userDetailsRef.once('value', function(snapshot) {
        var userDetails = snapshot.val();
        var employeeTableHtml = '<h2>Store Data</h2><div class="table-responsive"><table class="table">';
        employeeTableHtml += '<thead><tr><th>User ID</th><th>User Name</th><th>Balance</th><th>Location</th><th>Status</th></tr></thead>';
        employeeTableHtml += '<tbody>';
        for (var userId in userDetails) {
            if (userDetails[userId].userType === 'Store') {
                employeeTableHtml += '<tr>';
                employeeTableHtml += '<td>' + userDetails[userId].id + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].userName + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].balance + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].location + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].status + '</td>';
                employeeTableHtml += '</tr>';

                empData.push({
                    'User ID': userDetails[userId].id,
                    'User Name': userDetails[userId].userName,
                    'Balance': userDetails[userId].balance,
                    'Location': userDetails[userId].location,
                    'Status': userDetails[userId].status
                });
            }
        }
        employeeTableHtml += '</tbody></table></div>';
        document.getElementById('store').innerHTML = employeeTableHtml;
    });
}

function showAdminData() {
    var userDetailsRef = database.ref('userDetails');
    userDetailsRef.once('value', function(snapshot) {
        var userDetails = snapshot.val();
        var employeeTableHtml = '<thead><tr><th>User ID</th><th>User Name</th><th>Balance</th><th>Location</th><th>Status</th></tr></thead>';
        employeeTableHtml += '<tbody>';

        for (var userId in userDetails) {
            if (userDetails[userId].userType === 'Admin') {
                employeeTableHtml += '<tr>';
                employeeTableHtml += '<td>' + userDetails[userId].id + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].userName + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].balance + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].location + '</td>';
                employeeTableHtml += '<td>' + userDetails[userId].status + '</td>';
                employeeTableHtml += '</tr>';

                adminData.push({
                    'User ID': userDetails[userId].id,
                    'User Name': userDetails[userId].userName,
                    'Balance': userDetails[userId].balance,
                    'Location': userDetails[userId].location,
                    'Status': userDetails[userId].status
                });
            }
        }

        employeeTableHtml += '</tbody>';
        document.getElementById('adminTable').innerHTML = employeeTableHtml;
        document.getElementById('admin').style.display = 'block';
    });
}

function downloadDataExcel(xlData, xlFileName) {
    // Check if xlData is not empty
    if (xlData.length === 0) {
        alert('Data is empty. Unable to download Excel file.');
        return;
    }

    // Ask for confirmation to download Excel file
    if (!confirm('Do you want to download the Excel file?')) {
        return;
    }

    const fileType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8';
    const fileExtension = '.xlsx';
    const fileName = xlFileName + "_" + generateTransactionId();

    const ws = XLSX.utils.json_to_sheet(xlData);
    const wb = { Sheets: { 'data': ws }, SheetNames: ['data'] };
    const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const data = new Blob([excelBuffer], { type: fileType });
    saveAs(data, fileName + fileExtension);
}

function showFeedbacks(){
    // Reference to the feedbacks in the Firebase database
const feedbacksRef = database.ref('feedbacks');

// Fetch feedbacks from Firebase
feedbacksRef.once('value', snapshot => {
    const feedbacks = snapshot.val();
    if (feedbacks) {
        // Display feedbacks
        const feedbackList = document.getElementById('feedbackList');
        feedbackList.innerHTML = ''; // Clear previous list
        for (let feedbackId in feedbacks) {
            const feedback = feedbacks[feedbackId];
            feedbacksData.push(feedback);
            // Create a list item with Bootstrap styling for each feedback
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.style.marginBottom = '10px'; // Add margin to the bottom
            listItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">${feedback.message}</h5>
                    <small>${feedback.userName || 'Anonymous'}</small>
                </div>
                <small>${new Date(feedback.timestamp).toLocaleString()}</small>
            `;
            feedbackList.appendChild(listItem);
        }
    } else {
        console.log('No feedbacks found');
    }
});

}

function toggleSidebar() {
    var sidebar = document.querySelector('.sidebar');
    sidebar.classList.toggle('show');
}

document.getElementById('searchForm').addEventListener('submit', searchUser);

// Get the input element and the button element
var coinsLimitInput = document.getElementById('coinsLimit');
var updateCoinsLimitBtn = document.getElementById('updateCoinsLimitBtn');

// Add event listener to input field
coinsLimitInput.addEventListener('input', function() {
    // Check if the input field is empty
    if (coinsLimitInput.value.trim() !== '') {
        // Enable the button
        updateCoinsLimitBtn.disabled = false;
    } else {
        // Disable the button
        updateCoinsLimitBtn.disabled = true;
    }
});

function updateCoinsLimit() {
    var newCoinsLimit = document.getElementById('coinsLimit').value;
    database.ref('config/coinsLimit').set(newCoinsLimit)
        .then(() => {
            addLog('Coins Limit updated to' + newCoinsLimit);
            alert('Coins Limit updated successfully');
        })
        .catch(error => {
            console.error('Error updating Coins Limit:', error);
            alert('Failed to update Coins Limit. Please try again.');
        });
}

// Fetch the config data from Firebase
var configRef = database.ref('config');
configRef.once('value', function(snapshot) {
    var config = snapshot.val();
    coinsLimit = config.coinsLimit;
    locations = Object.entries(config.locations); // Convert locations object to array of key-value pairs
    userTypes = Object.values(config.userType);
    document.getElementById('coinsLimit').value = coinsLimit;


    // Display locations
    var locationsList = document.getElementById('locationsList');
    updateLocationsList(locationsList, locations);

    // Display user types
    var userTypesList = document.getElementById('userTypesList');
    userTypesList.innerHTML = userTypes.map(userType => `<li>${userType}</li>`).join('');
});

function updateLocationsList(locationsList, locations) {
    locationsList.innerHTML = locations.map(location => {
        return `<li><input type="text" value="${location[1]}" onchange="updateLocation('${location[0]}', this.value)"> <button class="btn btn-primary" onclick="removeLocation('${location[0]}')">Remove</button></li>`;
    }).join('');
}

function updateLocation(locationId, newValue) {
    var updates = {};
    updates['config/locations/' + locationId] = newValue;
    database.ref().update(updates)
        .then(() => {
            addLog('Location updated ' + newValue);
            // Fetch the updated config data and update the locations list
            database.ref('config').once('value', function(snapshot) {
                var config = snapshot.val();
                locations = Object.entries(config.locations);
                var locationsList = document.getElementById('locationsList');
                updateLocationsList(locationsList, locations);
            });
        })
        .catch(error => {
            console.error('Error updating location:', error);
        });
}

function removeLocation(locationId) {
    var confirmation = confirm('Are you sure you want to remove this location?');
    if (confirmation) {
        addLog('Location removed ' + locationId);
        database.ref('config/locations/' + locationId).remove()
            .then(() => {
                // Fetch the updated config data and update the locations list
                database.ref('config').once('value', function(snapshot) {
                    var config = snapshot.val();
                    locations = Object.entries(config.locations);
                    var locationsList = document.getElementById('locationsList');
                    updateLocationsList(locationsList, locations);
                });
            })
            .catch(error => {
                console.error('Error removing location:', error);
            });
    }
}

function addLocation() {
    var newLocation = prompt('Enter new location:');
    if (newLocation) {
        addLog('Location added ' + newLocation);
        var locationId = database.ref('config/locations').push().key;
        var updates = {};
        updates['config/locations/' + locationId] = newLocation;
        database.ref().update(updates)
            .then(() => {
                // Fetch the updated config data and update the locations list
                database.ref('config').once('value', function(snapshot) {
                    var config = snapshot.val();
                    locations = Object.entries(config.locations);
                    var locationsList = document.getElementById('locationsList');
                    updateLocationsList(locationsList, locations);
                });
            })
            .catch(error => {
                console.error('Error adding location:', error);
            });
    }
}

function addUserType() {
    var newUserType = prompt('Enter new user type:');
    if (newUserType) {
        addLog('New User Type added ' + newCoinsLimit);
        database.ref('config/userType').push(newUserType);
    }
}

function closeSidebar() {
    var sidebar = document.querySelector('.sidebar');
    sidebar.classList.remove('show');
}

function populateLocationDropdown() {
    var configRef = database.ref('config');
    configRef.once('value', function(snapshot) {
        var config = snapshot.val();
        var locations = config.locations;
        var creditLocationSelect = document.getElementById('creditLocationSelect');
        creditLocationSelect.innerHTML = '';
        for (var locationId in locations) {
            var locationName = locations[locationId];
            var option = document.createElement('option');
            option.value = locationId;
            option.textContent = locationName;
            creditLocationSelect.appendChild(option);
        }
    });
}


// function showEncashData() {
//     var configRef = database.ref('stores');
//     configRef.once('value', function(snapshot) {
//         var storesData = snapshot.val(); // Assuming storesData is the object containing store information
//         // Get the select element
//         const selectStore = document.getElementById('selectStore');

//         // Iterate over the store data and populate the dropdown
//         Object.keys(storesData).forEach(storeId => {
//             const option = document.createElement('option');
//             option.value = storeId;
//             option.text = storeId;
//             selectStore.appendChild(option);
//         });

//         // Add change event listener to select element
//         selectStore.addEventListener('change', function() {
//             // Get the selected store ID
//             var selectedStoreId = this.value;

//             // Get the store name for the selected store ID
//             var storeName = storesData[selectedStoreId].name;

//             // Update the storeName input field with the selected store's name
//             document.getElementById('storeName').value = storeName;
//         });
//     });
// }

function showEncashData() {
    var configRef = database.ref('stores');
    configRef.once('value', function(snapshot) {
        var storesData = snapshot.val(); // Assuming storesData is the object containing store information
        // Get the select element
        const selectStore = document.getElementById('selectStore');

        // Add a default option to prompt the user to select a store
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.text = 'Select a Store';
        selectStore.appendChild(defaultOption);

        // Iterate over the store data and populate the dropdown
        Object.keys(storesData).forEach(storeId => {
            const option = document.createElement('option');
            option.value = storeId;
            option.text = storesData[storeId].name; // Use store name as display text
            selectStore.appendChild(option);
        });

        // Add change event listener to select element
        selectStore.addEventListener('change', function() {
            // Get the selected store ID
            var selectedStoreId = this.value;

            // Get the store name for the selected store ID
            var storeName = selectedStoreId ? storesData[selectedStoreId].name : '';

            // Update the storeName input field with the selected store's name
            document.getElementById('storeName').value = storeName;
        });
    });
}




// Fetch locations from Firebase and populate the dropdown
var locationsSelect = document.getElementById('newUserLocation');

firebase.database().ref('config/locations').once('value', function(snapshot) {
    snapshot.forEach(function(childSnapshot) {
        var key = childSnapshot.key;
        var value = childSnapshot.val();
        var option = document.createElement('option');
        option.value = key;
        option.text = value;
        locationsSelect.appendChild(option);
    });
});

document.getElementById('creditForm').addEventListener('submit', function(event) {
        event.preventDefault();
        var locationSelect = document.getElementById('creditLocationSelect');
        var location = locationSelect.options[locationSelect.selectedIndex].text;
        var coins = parseInt(document.getElementById('coinsInput').value);
        var addWithExistingBalance = document.getElementById('addWithExistingBalance').checked;

        if (!location || isNaN(coins) || coins <= 0) {
            alert('Please select a location and enter a valid number of coins.');
            return;
        }

        var userDetailsRef = database.ref('userDetails');
        userDetailsRef.once('value', function(snapshot) {
            snapshot.forEach(function(childSnapshot) {
                var childKey = childSnapshot.key;
                var childData = childSnapshot.val();
                if (childData.location === location && childData.status.toLowerCase() !='inactive' && childData.userType.toLowerCase() !== 'store' && childData.userType.toLowerCase() !== 'admin') {
                    var newBalance = addWithExistingBalance ? (childData.balance + coins) : coins;
                    userDetailsRef.child(childKey).update({ 
                        balance: newBalance 
                    }).then(() => {
                        const currentDate = new Date();

                        const day = String(currentDate.getDate()).padStart(2, '0');
                        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                        const year = currentDate.getFullYear();

                        const hours = String(currentDate.getHours()).padStart(2, '0');
                        const minutes = String(currentDate.getMinutes()).padStart(2, '0');
                        const seconds = String(currentDate.getSeconds()).padStart(2, '0');

                        const formattedDate = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;

                        const transactionId = generateTransactionId();
                        const transaction = {
                            tCoins: newBalance,
                            tFrom: userDetails.id,
                            tFromName: userDetails.userName,
                            tTo: childData.id, // Assuming this is the store ID or some identifier
                            tToName: childData.userName, // Assuming this is the store name
                            tId: transactionId, // Generating a unique ID with a timestamp
                            tType: 'Credit', // Assuming this is the type of transaction (e.g., 'order', 'refund', etc.)
                            tStatus: 'Done',
                            tDate: formattedDate
                        };

                        // Push the transaction to the Firebase database
                        const transactionsRef = database.ref('creditTransactions');
                        transactionsRef.child(transactionId).set(transaction)
                    });
                }
            });
            addLog(coins+ ' Coins credited to location '+location);
            alert('Coins credited successfully.');
            document.getElementById('creditForm').reset();
        });
    });

    var userList = [];

// Function to add user to the list
function addUserToList() {
    var table = document.getElementById('userList').getElementsByTagName('tbody')[0];
    var newRow = table.insertRow();

    var userIdCell = newRow.insertCell();
    var userNameCell = newRow.insertCell();
    var locationCell = newRow.insertCell();

    var userId = document.getElementById('newUserId').value;
    var userName = document.getElementById('newUserName').value;
    var locationSelect = document.getElementById('newUserLocation');
    var location = locationSelect.options[locationSelect.selectedIndex].text;
    var userType = document.getElementById('newUserType').value;
    userIdCell.textContent = userId;
    userNameCell.textContent =  userName;
    // locationCell.textContent = document.getElementById('newUserLocation').value;
    locationCell.textContent = location;

    userList.push({ userId: userId, userName: userName, location: location, password: userId, status: 'Active', userType: userType });

    document.getElementById('newUserId').value = '';
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserLocation').value = '';
    document.getElementById('newUserPassword').value = '';

}

function handleSubmitCreateUsers(event) {
  event.preventDefault();

  var db = firebase.database();
  // Iterate over the userList array and create each user in Firebase
  userList.forEach(function(user) {
    db.ref('userDetails/' + user.userId).set({
      userName: user.userName,
      location: user.location,
      password: user.password,
      id: user.userId,
      userType: user.userType, // Example, you can set the user type as needed
      balance: 0,
      status: user.status
    }).then(function() {
      console.log('User created successfully:', user.userId);
      // If user type is 'store', create a store in the 'stores' Firebase node
      if (user.userType === 'Store') {
        db.ref('stores/' + user.userId).set({
          id: user.userId,
          name: user.userName,
          location: user.location,
          orderCounter: 0,
          menu: {} // Initialize an empty menu
        }).then(function() {
          console.log('Store created successfully:', user.userId);
        }).catch(function(error) {
          console.error('Error creating store:', user.userId, error);
        });
      }
    }).catch(function(error) {
      console.error('Error creating user:', user.userId, error);
    });
  });

  // Clear the userList array
  userList = [];
  clearUserList();
}

function clearUserList() {
    var table = document.getElementById("userList");
    var rowCount = table.rows.length;
    for (var i = rowCount - 1; i > 0; i--) {
        table.deleteRow(i);
    }
}

function updatePassword() {
    var userId = document.getElementById('newUserId').value;
    document.getElementById('newUserPassword').value = userId;
}

function showTransactionHistory() {
    // Reference to the transaction history in the Firebase database
    const transactionHistoryRef = database.ref('transactions');

    // Fetch transaction history from Firebase
    transactionHistoryRef.once('value', snapshot => {
        const transactions = snapshot.val();
        if (transactions) {
            // Display transaction history by store
            const transactionHistoryList = document.getElementById('transactionHistoryList');
            transactionHistoryList.innerHTML = ''; // Clear previous list
            for (let storeId in transactions) {
                const storeTransactions = transactions[storeId];
                const storeName = storeId; // Get store name by ID
                const storeItem = document.createElement('li');
                storeItem.className = 'store-transaction-item';
                storeItem.innerHTML = `
                    <div class="store-name" onclick="toggleTransactions(this)">
                        <span class="dropdown-icon">▶</span>
                        ${storeName}
                    </div>
                    <ul class="store-transaction-list" style="display:none;"></ul>
                `;
                const storeTransactionList = storeItem.querySelector('.store-transaction-list');
                for (let transactionId in storeTransactions) {
                    const transaction = storeTransactions[transactionId];
                    const transactionItem = document.createElement('li');
                    transactionItem.textContent = `${transaction.tDate} - ${transaction.tFromName} to ${transaction.tToName} (${transaction.tCoins} coins)`;
                    storeTransactionList.appendChild(transactionItem);
                }
                transactionHistoryList.appendChild(storeItem);
            }

            // Show the transaction history section
            document.querySelector('.transaction-history').style.display = 'block';
        } else {
            console.log('No transaction history found');
        }
    });
}

function toggleTransactions(element) {
    const transactionList = element.nextElementSibling;
    transactionList.style.display = transactionList.style.display === 'none' ? 'block' : 'none';
}

const transactionHistoryRef = database.ref('transactions');


document.getElementById('downloadButtonTransactions').addEventListener('click', () => {
    // Fetch transaction history from Firebase
    transactionHistoryRef.once('value', snapshot => {
        const transactions = snapshot.val();
        if (transactions) {
            // Convert transaction history to Excel file format
            const wb = XLSX.utils.book_new();

            // Add individual store transaction sheets
            for (let storeId in transactions) {
                const storeTransactions = transactions[storeId];
                const ws = XLSX.utils.json_to_sheet(Object.values(storeTransactions));
                XLSX.utils.book_append_sheet(wb, ws, storeId); // Implement a function to get store name by ID
            }

            // Add summary sheet based on date and store
            const summarySheetData = {};
            for (let storeId in transactions) {
                const storeTransactions = transactions[storeId];
                for (let transactionId in storeTransactions) {
                    const transaction = storeTransactions[transactionId];
                    const date = transaction.tDate.split(' ')[0]; // Extract date part

                    if (!summarySheetData[date]) {
                        summarySheetData[date] = {};
                    }
                    if (!summarySheetData[date][storeId]) {
                        summarySheetData[date][storeId] = {
                            Date: date,
                            Store: storeId,
                            TotalCoins: 0
                        };
                    }
                    summarySheetData[date][storeId].TotalCoins += transaction.tCoins;
                }
            }

            // Flatten the summary sheet data
            const flatSummarySheetData = Object.values(summarySheetData).reduce((acc, val) => acc.concat(Object.values(val)), []);
            const summarySheet = XLSX.utils.json_to_sheet(flatSummarySheetData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

            // Save the Excel file
            XLSX.writeFile(wb, 'transaction_history.xlsx');
        } else {
            console.log('No transaction history found');
        }
    });
});

function logout(){
    if (confirm('Are you sure you want to logout?')) {
       // Clear user details from localStorage
       localStorage.removeItem('userDetails');
        // Redirect to the login page
        window.location.href = 'index.html';
    }                 
}

function generateTransactionId() {
    const currentDateTime = new Date();
    const year = currentDateTime.getFullYear();
    const month = ('0' + (currentDateTime.getMonth() + 1)).slice(-2); // Months are zero-based
    const date = ('0' + currentDateTime.getDate()).slice(-2);
    const hours = ('0' + currentDateTime.getHours()).slice(-2);
    const minutes = ('0' + currentDateTime.getMinutes()).slice(-2);
    const seconds = ('0' + currentDateTime.getSeconds()).slice(-2);
    return `${year}${month}${date}${hours}${minutes}${seconds}`;
}

function showCreditTransactionHistory() {
    // Reference to the credit transaction history in the Firebase database
    const transactionHistoryRef = database.ref('creditTransactions');

    // Fetch credit transaction history from Firebase
    transactionHistoryRef.once('value', snapshot => {
        const creditTransactions = snapshot.val();
        if (creditTransactions) {
            // Display credit transaction history
            const creditHistoryList = document.getElementById('creditHisList');
            creditHistoryList.innerHTML = ''; // Clear previous list
            Object.values(creditTransactions).forEach(creditTransaction => {
                // Create a list item for each credit transaction
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0"><strong>Date:</strong> ${creditTransaction.tDate}</p>
                            <p class="mb-0"><strong>Coins:</strong> ${creditTransaction.tCoins}</p>
                        </div>
                        <div>
                            <p class="mb-0"><strong>From:</strong> ${creditTransaction.tFrom}</p>
                            <p class="mb-0"><strong>To:</strong> ${creditTransaction.tTo}</p>
                        </div>
                    </div>
                `;
                creditHistoryList.appendChild(listItem);

                creditHistoryData.push({
                    'Date': creditTransaction.tDate,
                    'Coins': creditTransaction.tCoins,
                    'From': creditTransaction.tFrom,
                    'To': creditTransaction.tTo,
                    'To Name': creditTransaction.tToName
                });
            });
            // Show the credit transaction history section
            document.getElementById('credHis').style.display = 'block';
        } else {
            console.log('No credit transaction history found');
        }
    });
}

function showEncashHistory() {
    // Reference to the credit transaction history in the Firebase database
    const transactionHistoryRef = database.ref('encashTransactions');

    // Fetch credit transaction history from Firebase
    transactionHistoryRef.once('value', snapshot => {
        const creditTransactions = snapshot.val();
        if (creditTransactions) {
            // Display credit transaction history
            const creditHistoryList = document.getElementById('encashHisList');
            creditHistoryList.innerHTML = ''; // Clear previous list
            Object.values(creditTransactions).forEach(creditTransaction => {
                // Create a list item for each credit transaction
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0"><strong>Date:</strong> ${creditTransaction.tDate}</p>
                            <p class="mb-0"><strong>Coins:</strong> ${creditTransaction.tCoins}</p>
                        </div>
                        <div>
                            <p class="mb-0"><strong>From:</strong> ${creditTransaction.tFrom}</p>
                            <p class="mb-0"><strong>To:</strong> ${creditTransaction.tTo}</p>
                        </div>
                    </div>
                `;
                encashHisList.appendChild(listItem);

                encashData.push({
                    'Date': creditTransaction.tDate,
                    'Coins': creditTransaction.tCoins,
                    'From': creditTransaction.tFrom,
                    'To': creditTransaction.tTo,
                    'To Name': creditTransaction.tToName
                });
            });
            // Show the credit transaction history section
            document.getElementById('encashHis').style.display = 'block';
        } else {
            console.log('No encash transaction history found');
        }
    });
}

document.getElementById('encashForm').addEventListener('submit', function(event) {
    event.preventDefault();

    var idSelect = document.getElementById('selectStore');
    var storeId = idSelect.options[idSelect.selectedIndex].text;
    var storeName = document.getElementById('storeName').value;
    var encashAmount = parseInt(document.getElementById('encashAmount').value);

    // Check if any of the fields are empty
    if (!storeId || storeId=='Select a Store' || !storeName || isNaN(encashAmount)) {
        alert('Please fill in all the fields and make sure the encashed amount is a valid number.');
        return;
    }

    const currentDate = new Date();
    const day = String(currentDate.getDate()).padStart(2, '0');
    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    const year = currentDate.getFullYear();
    const hours = String(currentDate.getHours()).padStart(2, '0');
    const minutes = String(currentDate.getMinutes()).padStart(2, '0');
    const seconds = String(currentDate.getSeconds()).padStart(2, '0');
    const formattedDate = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
    const transactionId = generateTransactionId();
    const transaction = {
        tCoins: encashAmount,
        tFrom: userDetails.id,
        tFromName: userDetails.userName,
        tTo: storeId,
        tToName: storeName,
        tId: transactionId,
        tType: 'Encash',
        tStatus: 'Done',
        tDate: formattedDate
    };

    // Push the transaction to the Firebase database
    const transactionsRef = database.ref('encashTransactions');
    transactionsRef.child(transactionId).set(transaction)
        .then(() => {
            addLog('Encashed '+ encashAmount + ' to '+ storeId + '('+storeName+')');
            alert('Encashment transaction successful!');
            document.getElementById('encashForm').reset();
        })
        .catch(error => {
            alert('Failed to process encashment transaction. Please try again.');
            console.error('Error adding encashment transaction: ', error);
        });
});

function showLogsHistory() {
    // Reference to the credit transaction history in the Firebase database
    const logsRef = database.ref('logs');

    // Fetch the log history once
    logsRef.once('value').then(function(snapshot) {
        const logsList = document.getElementById('logsList');
        logsList.innerHTML = ''; // Clear existing logs

        snapshot.forEach(function(childSnapshot) {
            const logData = childSnapshot.val();
            const logItem = document.createElement('li');
            logItem.classList.add('list-group-item');
            logItem.textContent = logData.message + ' - ' + new Date(logData.timestamp).toString() + ' - by ' + logData.userId + ' ( ' + logData.userName + ' ) ';

            logDataList.push({
                    'Date': new Date(logData.timestamp).toString(),
                    'Message': logData.message,
                    'UserId': logData.userId,
                    'UserName': logData.userName
                });

            logsList.appendChild(logItem);
        });
    });
}

var selectedStore = null; // Define selectedStore globally

function renderStores() {
    var storesRef = firebase.database().ref("stores");
    
    storesRef.once("value", function(snapshot) {
        var storeSelect = document.getElementById("storeSelect");
        // Clear old values in storeSelect
        storeSelect.innerHTML = "";

        // Add default "Select a Store" option
        var defaultOption = document.createElement("option");
        defaultOption.text = "Select a Store";
        defaultOption.value = "";
        storeSelect.appendChild(defaultOption);
        
        snapshot.forEach(function(childSnapshot) {
            var storeId = childSnapshot.key;
            var store = childSnapshot.val();
            var option = document.createElement("option");
            option.text = store.name;
            option.value = storeId;
            storeSelect.appendChild(option);
        });

        // // Add event listener to listen for changes in the dropdown
        // storeSelect.addEventListener("change", function() {
        //     selectedStore = snapshot.child(this.value).val(); // Set selectedStore globally
        //     showMenuItems(this.value, selectedStore.menu);
        // });

        // Add event listener to listen for changes in the dropdown
        storeSelect.addEventListener("change", function() {
            var selectedValue = this.value;
            if (selectedValue === "") {
                // Clear the menu items list if "Select a Store" is selected
                document.getElementById("menuList").innerHTML = "";
            } else {
                selectedStore = snapshot.child(selectedValue).val(); // Set selectedStore globally
                showMenuItems(selectedValue, selectedStore.menu);
            }
        });
    }, function(error) {
        console.error("Error getting stores: ", error);
    });
}

function deleteMenuItem(storeId, menuItemKey) {
    const storeRef = firebase.database().ref(`stores/${storeId}/menu`);
    storeRef.child(menuItemKey).remove().then(() => {
        console.log(`${menuItemKey} deleted from menu`);
        if (selectedStore) {
            showMenuItems(storeId, selectedStore.menu); // Refresh the menu items list
        }
    }).catch(error => {
        console.error('Error deleting item:', error);
    });
}

function showMenuItems(storeId) {
    var menuList = document.getElementById("menuList");
    if (!menuList) {
        console.error("Menu list element not found");
        return;
    }

    // Clear previous menu items
    menuList.innerHTML = "";

    // Display the form to add a new item
    var addItemForm = document.getElementById("addItemForm");
    if (addItemForm) {
        addItemForm.innerHTML = ""; // Clear previous form elements

        var itemNameInput = document.createElement("input");
        itemNameInput.type = "text";
        itemNameInput.id = "itemName";
        itemNameInput.placeholder = "Item Name";

        var itemPriceInput = document.createElement("input");
        itemPriceInput.type = "number";
        itemPriceInput.id = "itemPrice";
        itemPriceInput.placeholder = "Item Price";

        var addItemButton = document.createElement("button");
        addItemButton.textContent = "Add Item";
        addItemButton.addEventListener("click", function() {
            var itemName = itemNameInput.value.trim();
            var itemPrice = itemPriceInput.value.trim();

            if (itemName && itemPrice) {
                addItem(storeId, itemName, itemPrice);
                itemNameInput.value = "";
                itemPriceInput.value = "";
            } else {
                alert("Please enter item name and price.");
            }
        });

        addItemForm.appendChild(itemNameInput);
        addItemForm.appendChild(itemPriceInput);
        addItemForm.appendChild(addItemButton);
    }

    const storeRef = firebase.database().ref(`stores/${storeId}/menu`);
    
    // Listen for changes in the menu items
    storeRef.on("value", function(snapshot) {
        menuList.innerHTML = ""; // Clear previous menu items

        snapshot.forEach(function(childSnapshot) {
            var menuItemKey = childSnapshot.key;
            var menuItem = childSnapshot.val();
            var menuItemElement = document.createElement("div");

            // Display the menu item name and price
            var itemInfo = document.createElement("span");
            itemInfo.textContent = menuItem.name + " - Price: " + menuItem.price;
            menuItemElement.appendChild(itemInfo);

            // Create an Edit button
            var editButton = document.createElement("button");
            editButton.textContent = "Edit";
            editButton.addEventListener("click", function(key, name, price) {
                return function() {
                    var updatedName = prompt("Enter the updated name:", name);
                    var updatedPrice = prompt("Enter the updated price:", price);
                    if (updatedName !== null && updatedPrice !== null) {
                        editMenuItem(storeId, key, updatedName, updatedPrice);
                    } else {
                        alert("Please enter both name and price.");
                    }
                };
            }(menuItemKey, menuItem.name, menuItem.price));
            menuItemElement.appendChild(editButton);

            // Create a Delete button
            var deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", function(key) {
                return function() {
                    deleteMenuItem(storeId, key);
                };
            }(menuItemKey));
            menuItemElement.appendChild(deleteButton);

            menuList.appendChild(menuItemElement);
        });
    });
}


function editMenuItem(storeId, menuItemKey, updatedName, updatedPrice) {
    const storeRef = firebase.database().ref(`stores/${storeId}/menu/${menuItemKey}`);
    
    // Check if updatedPrice is defined
    if (updatedPrice !== undefined) {
        storeRef.update({
            name: updatedName,
            price: updatedPrice
        }).then(() => {
            console.log(`${menuItemKey} updated in menu`);
            showMenuItems(storeId, selectedStore.menu); // Refresh the menu items list
        }).catch(error => {
            console.error('Error updating item:', error);
        });
    } else {
        console.error('Error updating item: Price is undefined');
    }
}

function addItem(storeId, itemName, itemPrice) {
    const storeRef = firebase.database().ref(`stores/${storeId}/menu/${itemName}`);
    storeRef.set({
        name: itemName,
        price: itemPrice,
        disabled: false
    }).then(() => {
        console.log(`${itemName} added to menu`);
        renderStores(); // Refresh the store list
    }).catch(error => {
        console.error('Error adding item:', error);
    });
}




</script>
</body>

</html>
