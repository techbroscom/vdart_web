  <!DOCTYPE html>
  <html lang="en">
  <head>
        <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Food Order</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
      <!-- Custom CSS -->

      <style>
        body {
            background-color: #f8f9fa;
            margin-bottom: 60px; /* Add margin for the toggle button */
        }
        .container {
            margin: 50px auto;
        }
        /* .user-details {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        } */
        /* .user-details {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
    margin-bottom: 20px;
}

.user-details h2 {
    color: #333;
    font-size: 24px;
    margin-bottom: 10px;
}

.user-details h4 {
    color: #666;
    font-size: 18px;
    margin-bottom: 5px;
}

.user-details h5 {
    color: #666;
    font-size: 16px;
    margin-bottom: 5px;
} */
/* Update the styles as needed */
.user-details {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 20px;
    }

    .user-details h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
    }

    .user-details h4 {
        color: #666;
        font-size: 18px;
        margin-bottom: 5px;
    }

    .user-details h5 {
        color: #666;
        font-size: 16px;
        margin-bottom: 5px;
    }

        .store-list {
            background-color: #fff;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        /* .store-list {
        background-color: #fff;
        padding: 20px;
        margin-top: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    } */
        .menu-list {
            background-color: #fff;
            padding: 20px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .menu-item {
            margin-bottom: 10px;
        }
        .navbar {
            background-color: #007bff; /* Set the navbar color to #007bff */
        }
        .nav-header {
            background-color: #007bff;
            color: #fff;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 20px;
        }
        .pending-transaction {
            /* background-color: #ffc107; Yellow color for pending */
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        .completed-transaction {
            background-color: #28a745; /* Green color for completed */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .cancelled-transaction {
            background-color: #dc3545; /* Red color for cancelled */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .card {
    width: 100%;
    cursor: pointer;
    perspective: 1000px;
    margin: 0 auto; /* Center the card */
    box-sizing: border-box; /* Include padding in the width */
}

.card-inner {
    width: 100%;
    height: 100%;
    position: relative;
    transition: transform 1s;
    transform-style: preserve-3d;
}

.front, .back {
    width: 100%;
    height: 100%;
    background-image: linear-gradient(45deg, #0045c7, #ff2c7d);
    position: absolute;
    top: 0;
    left: 0;
    padding: 20px 30px;
    border-radius: 15px;
    overflow: hidden;
    z-index: 1;
    backface-visibility: hidden;
    box-sizing: border-box; /* Include padding in the height */
}

.row {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.map-img {
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0.3;
    z-index: -1;
}

.card-no {
    font-size: 35px;
    margin-top: 60px;
}

.card-holder {
    font-size: 12px;
    margin-top: 40px;
}

.name {
    font-size: 22px;
    margin-top: 20px;
}

.bar {
    background: #222;
    margin-left: -30px;
    margin-right: -30px;
    height: 60px;
    margin-top: 10px;
}

.card-cvv {
    margin-top: 20px;
}

.card-cvv div {
    flex: 1;
}

.card-cvv img {
    width: 100%;
    display: block;
    line-height: 0;
}

.card-cvv p {
    background: #fff;
    color: #000;
    font-size: 22px;
    padding: 10px 20px;
}

.card-text {
    margin-top: 30px;
    font-size: 14px;
}

.signature {
    margin-top: 30px;
}

.back {
    transform: rotateY(180deg);
}

.card:hover .card-inner {
    transform: rotateY(-180deg);
}

.noStoresMessage {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin-bottom: 20px;
    }

/* feedback
.feedback-container {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
}

.feedback-container h3 {
    margin-bottom: 15px;
}

.feedback-container form {
    margin-top: 20px;
}

.feedback-container label {
    font-weight: bold;
}

.feedback-container textarea {
    resize: vertical; /* Allow vertical resizing */
/* }

.feedback-container button {
    margin-top: 10px;
} */ 

/* Feedback Form Styling */
.feedback-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
    }

    .feedback-container h3 {
        margin-bottom: 15px;
        color: #333;
    }

    .feedback-container form {
        margin-top: 20px;
    }

    .feedback-container label {
        font-weight: bold;
        color: #333;
    }

    .feedback-container textarea {
        resize: vertical; /* Allow vertical resizing */
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }

    .feedback-container button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .feedback-container button:hover {
        background-color: #0056b3;
    }
    .loading {
            display: none; /* Hide the loading div by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8); /* Semi-transparent white background */
            z-index: 1000; /* Ensure the loading div is above other elements */
            animation: fadeIn 0.5s ease-in-out; /* Fade in animation */
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #333; /* Color of the loading spinner */
            animation: spin 1s linear infinite; /* Spin animation */
        }
        .loading-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: fadeIn 2s linear infinite; /* Spin animation */
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-primary center">
        <span class="navbar-brand mb-0 h1">VDart Cafe Wallets</span>
        <button id="logoutButton" class="btn btn-outline-light">Logout</button>
    </nav>

<div class="container">
    <!-- User Details -->
    <div class="user-details">
        <h2>Welcome, <span id="userName"></span>!</h2>
        <h4>Id: <span id="userId"></span></h4>
        <h4>Your Balance: <span id="userBalance"></span></h4>
        <h4>Coins Utilization: <span id="userCoinsUtilization"></span></h4>
        <h5>Message: <span id="userMessage"></span></h4>
    </div>
    

    <div class="loading" id="loading">
        <!-- Replace 'logo.png' with the path to your logo image -->
        <div class="loading-spinner"></div>
    </div>

    <div class="noStoresMessage" id="noStoresMessage" style="display: none;">No stores found in your location.</div>

    <!-- Store List -->
    <div class="store-list" style="display: none;">
        <h3>Stores List:</h3>
        <ul id="storesList"></ul>
    </div>

    <!-- Oops Msg -->
    <div id="limitReachedMsg" style="display: none; background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-top: 20px;">
        <strong>Oops!</strong> You have reached the limit for the day.
    </div>

    <!-- Pending Transaction Details -->
    <div id="pendingTransaction" style="display: none;" class="pending-transaction">
        <h3>Order Details:</h3>
        <div id="pendingTransactionItems"></div>
    </div>

    <div id="transactionHistory" class="pending-transaction">
        <h3>Transactions:</h3>
        <div id="transactionItems"></div>
    </div>

    <div class="feedback-container">
        <h3>Feedback</h3>
        <form id="feedbackForm">
            <div class="form-group">
                <label for="feedbackMessage">Message:</label>
                <textarea class="form-control" id="feedbackMessage" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

</div>

  <!-- Firebase JavaScript SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Initialize Firebase -->
  <script>
      const firebaseConfig = {
    apiKey: "AIzaSyCvcxuv1-MWBtHMIUkeqGH_gfyBWaNN7K0",
    authDomain: "vdarttest.firebaseapp.com",
    projectId: "vdarttest",
    storageBucket: "vdarttest.appspot.com",
    messagingSenderId: "157342186908",
    databaseURL: "https://vdarttest-default-rtdb.asia-southeast1.firebasedatabase.app",
    appId: "1:157342186908:web:ea6c53598d3e9d1cab9c59",
    measurementId: "G-NVXLVD13D1"
  };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // Reference to the Firebase database
      const db = firebase.database();

      const loadingDiv = document.getElementById('loading');
    loadingDiv.style.display = 'block';

      

      // Logout button event listener
const logoutButton = document.getElementById('logoutButton');
logoutButton.addEventListener('click', () => {
    if (confirm('Are you sure you want to logout?')) {
        // Clear user details from localStorage
        localStorage.removeItem('userDetails');
        // Redirect to the login page
        window.location.href = 'index.html';
    }
});

      // Display user details
const userDetails = JSON.parse(localStorage.getItem('userDetails'));
if (!userDetails) {
    console.log('User details not found');
    window.location.href = 'index.html';
} else {
    document.getElementById('userName').innerText = userDetails.userName;
    document.getElementById('userBalance').innerText = userDetails.balance;
    document.getElementById('userMessage').innerText = userDetails.message;
    document.getElementById('userId').innerText = userDetails.id;
    document.getElementById('userCoinsUtilization').innerText = userDetails.coinsUtil;
    renderTransactions(userDetails.transactions);
    const lastTranDate = new Date(userDetails.lastTranDate);
    const currentDate = new Date();

    if (lastTranDate.toDateString() === currentDate.toDateString()) {
        console.log('lastTranDate is the current date.');
    } 
    else if(lastTranDate.toDateString() != currentDate.toDateString() && userDetails.coinsUtil!=0){
        userDetails.coinsUtil = 0;

        db.ref('userDetails/' + userDetails.id).update({
                coinsUtil: 0
            }).then(() => {
                localStorage.setItem('userDetails', JSON.stringify(userDetails));
                document.getElementById('userCoinsUtilization').innerText = userDetails.coinsUtil;
            }).catch(error => {
                console.error('Error updating coins util: ', error);
            });
        console.log('lastTranDate is not the current date.');
    }

    if (userDetails.isOrderPending) {

        document.querySelector('.store-list').style.display = 'none';

    // If there is a pending order, show the transaction details
    const pendingTranId = userDetails.pendingTransId;
    const pendingStoreId = userDetails.orderStore;
    const pendingTranRef = db.ref('transactions').child(pendingStoreId).child(pendingTranId);
    pendingTranRef.once('value', snapshot => {
        document.getElementById('loading').style.display = 'none';

        const pendingTran = snapshot.val();
        if (pendingTran) {
            if(pendingTran.tStatus == "Delivered"){
                document.querySelector('.store-list').style.display = 'block'; // Show the store list

                // Update userDetails and display a message
                userDetails.isOrderPending = false;
                userDetails.message = "Your last order is delivered";
    localStorage.setItem('userDetails', JSON.stringify(userDetails));
                document.getElementById('userMessage').textContent = "Your last order is delivered";

                // Update userDetails in localStorage
                localStorage.setItem('userDetails', JSON.stringify(userDetails));

                // Update isOrderPending in the database
                const userRef = db.ref('userDetails').child(userDetails.id);
                userRef.update({
                    isOrderPending: false,
                    message: "Your last order is delivered"
                }).then(() => {
                    console.log("isOrderPending updated in the database");
                }).catch(error => {
                    console.error("Error updating isOrderPending in the database:", error);
                });
            }
            else{
            // Display pending transaction details in the new div element
            const pendingTransactionItems = document.getElementById('pendingTransactionItems');
            const pendingTransactionTotal = document.getElementById('pendingTransactionTotal');


// Clear the existing content of pendingTransactionItems
pendingTransactionItems.innerHTML = '';

// Display items and price on the left column
pendingTransactionItems.innerHTML += `
<div class="row">
    <div class="col-6">
        ${pendingTran.items.map(item =>
            `<div style="color: #333;">
                <span style="color: #ff0000;">${item.name}</span> (Quantity: 
                <span>${item.quantity}</span>, Price: 
                <span style="color: #0000ff;">₹${item.price.toFixed(2)}</span>)
            </div>`
        ).join('')}
        <div>
            Total: ₹<span style="font-weight: bold">${pendingTran.tCoins.toFixed(2)}</span>
        </div>
    </div>
    <div class="col-6">
        <div style="text-align: center;">
            <div style="font-size: 14px; color: #777;">Order No:</div>
            <div style="font-size: 30px; color: #ff0000; font-weight: bold;">${pendingTran.tOrderNum}</div>
        </div>
    </div>
</div>`;




// Set the total amount
// pendingTransactionTotal.textContent = `₹${pendingTran.tCoins.toFixed(2)}`;

            document.getElementById('pendingTransaction').style.display = 'block';
            }
        } else {
            console.log('Pending transaction not found');
        }
    });
} else {
    showStoreUi();
    }  
}

function showStoreUi(){
    document.getElementById('loading').style.display = 'none';

    // If there is no pending order, display the store list

    const storesListRef = db.ref('stores');
    storesListRef.on('value', snapshot => {
    const stores = snapshot.val();
    const storesList = document.getElementById('storesList');
    const noStoresMessage = document.getElementById('noStoresMessage');
    storesList.innerHTML = ''; // Clear previous list
    if (!stores) {
        noStoresMessage.style.display = 'block'; // Show message
        console.log('No stores found in the database');
        return;
    }
    document.querySelector('.store-list').style.display = 'block'; // Show the store list
    let storesFound = false;
    for (let storeKey in stores) {
        const store = stores[storeKey];
        if(store.location === userDetails.location){
            const storeItem = document.createElement('div');
storeItem.className = 'card mb-3';
storeItem.style.cursor = 'pointer';
storeItem.innerHTML = `
<div class="card-body">
                    <div class="row">
                        <div class="col-2">
                            <div class="d-flex justify-content-center" style="height: 100%;"><i class="bi bi-shop"></i></div>
                        </div>
                        <div class="col-10">
                            <h5 class="card-title">${store.name}</h5>
                            <p class="card-text">${store.location}</p>
                        </div>
                    </div>
                </div>`;
        storeItem.addEventListener('click', () => {
            // Store the menu items for the selected store in localStorage
            localStorage.setItem('menuItems', JSON.stringify(store.menu));
            localStorage.setItem('storeDetails', JSON.stringify(store));
            // Navigate to the next page with store details and menu items
            window.location.href = 'menu.html';
        });
        storesList.appendChild(storeItem);
        }
    }
}, error => {
    console.error('Error fetching stores:', error);
});
}

var coinsLimit;

var configRef = db.ref('config');
  configRef.once('value', function(snapshot) {
      var config = snapshot.val();
      coinsLimit = config.coinsLimit;
      localStorage.setItem('config', JSON.stringify(config));
      if(userDetails.coinsUtil >= coinsLimit){
      document.getElementById('limitReachedMsg').style.display = 'block';
      document.querySelector('.store-list').style.display = 'none'; // Show the store list
      } 
  });

        // Feedback form submission event listener
const feedbackForm = document.getElementById('feedbackForm');
feedbackForm.addEventListener('submit', (event) => {
    event.preventDefault(); // Prevent default form submission

    // Get the feedback message from the form
    const feedbackMessage = document.getElementById('feedbackMessage').value;

    // Store the feedback message in Firebase
    const feedbackRef = db.ref('feedbacks').push(); // Create a new unique key for the feedback
    feedbackRef.set({
        message: feedbackMessage,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        userId: userDetails.id,
        userName: userDetails.userName // Store the current timestamp
    }).then(() => {
        alert('Feedback submitted successfully!');
        feedbackForm.reset(); // Reset the form after successful submission
    }).catch((error) => {
        console.error('Error submitting feedback:', error);
        alert('An error occurred. Please try again.');
    });
});

    function renderTransactions(transactions) {
    const transactionItemsElement = document.getElementById('transactionItems');
    transactionItemsElement.innerHTML = ''; // Clear previous items

    for (const key in transactions) {
        if (transactions.hasOwnProperty(key)) {
            const transaction = transactions[key];
            const transactionElement = document.createElement('div');
            transactionElement.classList.add('transaction-details', 'border', 'p-3', 'mb-3');
            transactionElement.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="items">
                            <strong>Items:</strong>
                            <ul>
                                ${transaction.items.map(item =>
                                    `<li>${item.name} (Qty: ${item.quantity}, ₹${item.price.toFixed(2)})</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="total-coins"><strong>Total:</strong> ${transaction.tCoins}</div>
                    </div>
                    <div class="col-md-3">
                        <div class="status"><strong>Status:</strong> ${transaction.tStatus}</div>
                    </div>
                </div>
            `;
            transactionItemsElement.appendChild(transactionElement);
        }
    }
}

// // Assuming userDetails is an object containing the user details
// const userRef = db.ref('userDetails').child(userDetails.id);

// // Listen for changes in user details in Firebase
// userRef.on('value', (snapshot) => {
//     const updatedUserDetails = snapshot.val();

//     // Update userDetails in local storage
//     localStorage.setItem('userDetails', JSON.stringify(updatedUserDetails));

//     // Update the UI
//     window.location.reload();
// });

const userRef = db.ref('userDetails').child(userDetails.id);

        // Listen for changes in user details in Firebase
        userRef.on('value', (snapshot) => {
            const updatedUserDetails = snapshot.val();

            // Update userDetails in local storage
            localStorage.setItem('userDetails', JSON.stringify(updatedUserDetails));

            // Update the UI without reloading the page
            document.getElementById('userName').innerText = updatedUserDetails.userName;
            document.getElementById('userBalance').innerText = updatedUserDetails.balance;
            document.getElementById('userMessage').innerText = updatedUserDetails.message;
            document.getElementById('userId').innerText = updatedUserDetails.id;
            document.getElementById('userCoinsUtilization').innerText = updatedUserDetails.coinsUtil;

            // If there is a pending order, update the UI accordingly
            if (updatedUserDetails.isOrderPending) {
                // Display the pending transaction details
                // You can implement this part as per your UI design
            } else {
                // Display the store list
                // You can implement this part as per your UI design
                showStoreUi();
            }
        });
  </script>
  </body>
  </html>
